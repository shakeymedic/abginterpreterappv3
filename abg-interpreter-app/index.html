<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>WMEBEM ABG/VBG Interpreter Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'wmebem-navy': '#0A2240',
                        'wmebem-blue': '#1A75C4',
                        'bg-light': '#F8F9FA',
                        'gray-text': '#6C757D',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .loader {
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        [x-cloak] { display: none !important; }
        .prose strong { color: #D92D20; font-weight: 600; }
        .input-error {
            border-color: #D92D20 !important;
            box-shadow: 0 0 0 2px rgba(217, 45, 32, 0.2);
        }
        /* Critical value highlighting */
        .critical-value {
            background: linear-gradient(45deg, #FEE2E2, #FECACA);
            border-left: 4px solid #DC2626;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        /* Mobile optimized inputs */
        @media (max-width: 640px) {
            input[type="number"], input[type="text"], textarea, select {
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px;
            }
            button {
                min-height: 48px;
            }
        }
        /* Swipe hint */
        .swipe-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.5;
            animation: swipeHint 2s ease-in-out infinite;
        }
        @keyframes swipeHint {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-bg-light font-sans">

    <div class="container mx-auto p-3 md:p-8" x-data="abgApp()">
        <!-- Mobile-Optimized Header -->
        <header class="text-left mb-6 md:mb-10 max-w-6xl mx-auto">
            <div class="flex items-center gap-3 md:gap-4">
                <img src="https://i.imgur.com/09eFLTO.png" alt="WMEBEM Logo" class="w-10 h-10 md:w-12 md:h-12">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-wmebem-navy">ABG/VBG Interpreter</h1>
                    <p class="text-xs md:text-md text-gray-text">West Midlands Evidence Based Emergency Medicine</p>
                </div>
            </div>
        </header>

        <!-- Disclaimer -->
        <div class="max-w-6xl mx-auto mb-4 bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-3 rounded-md text-sm" role="alert">
            <p><strong>Disclaimer:</strong> This tool is intended for educational and informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. All clinical decisions must be based on the independent judgment of a qualified healthcare professional.</p>
        </div>

        <!-- Mobile Tab Navigation -->
        <div class="lg:hidden mb-4 sticky top-0 z-10 bg-bg-light pb-2">
            <div class="flex gap-2 bg-white rounded-xl shadow-sm p-1">
                <button @click="activeTab = 'input'" 
                        :class="activeTab === 'input' ? 'bg-wmebem-blue text-white' : 'bg-transparent text-gray-600'"
                        class="flex-1 py-2.5 px-3 rounded-lg font-medium transition-all text-sm">
                    Input Data
                </button>
                <button @click="activeTab = 'results'" 
                        :class="activeTab === 'results' ? 'bg-wmebem-blue text-white' : 'bg-transparent text-gray-600'"
                        class="flex-1 py-2.5 px-3 rounded-lg font-medium transition-all text-sm relative">
                    Results
                    <span x-show="hasResults" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 lg:gap-8 max-w-6xl mx-auto">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-2" x-show="activeTab === 'input' || windowWidth >= 1024">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-gray-200/80 lg:sticky lg:top-8">
                    
                    <h2 class="text-lg md:text-xl font-bold text-wmebem-navy mb-4 border-b pb-3">Patient Data</h2>
                     
                    <!-- Sample Type Toggle - Mobile Optimized -->
                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-text">Sample Type</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <button @click="sampleType = 'Arterial'" 
                                    :class="sampleType === 'Arterial' ? 'bg-wmebem-blue text-white' : 'bg-white border-gray-300'"
                                    class="py-3 px-4 rounded-lg border font-medium transition-all">
                                Arterial
                            </button>
                            <button @click="sampleType = 'Venous'" 
                                    :class="sampleType === 'Venous' ? 'bg-wmebem-blue text-white' : 'bg-white border-gray-300'"
                                    class="py-3 px-4 rounded-lg border font-medium transition-all">
                                Venous
                            </button>
                        </div>
                    </div>

                    <!-- Input Mode Toggle -->
                    <div class="mb-5 bg-gray-100 p-1 rounded-lg flex gap-1">
                        <button @click="mode = 'manual'" 
                                :class="mode === 'manual' ? 'bg-wmebem-blue text-white' : 'text-gray-text bg-transparent'"
                                class="flex-1 py-2.5 text-sm font-semibold rounded-md transition-colors">
                            Manual Entry
                        </button>
                        <button @click="mode = 'image'" 
                                :class="mode === 'image' ? 'bg-wmebem-blue text-white' : 'text-gray-text bg-transparent'"
                                class="flex-1 py-2.5 text-sm font-semibold rounded-md transition-colors">
                            üì∑ Photo
                        </button>
                    </div>

                    <div class="space-y-4" id="inputForm">
                        <!-- Manual Input Grid - Mobile Optimized -->
                        <div x-show="mode === 'manual'" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Core Values - Highlighted -->
                            <div class="sm:col-span-2 bg-blue-50 p-3 rounded-lg">
                                <p class="text-xs font-semibold text-wmebem-blue mb-2">ESSENTIAL VALUES</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">pH <span class="text-xs text-gray-400">(7.35-7.45)</span></label>
                                        <input type="number" step="0.001" id="ph" x-model="values.ph" 
                                               @input="validateInput($event)" 
                                               data-min="6.8" data-max="7.8" 
                                               class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                               placeholder="7.40" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">pCO‚ÇÇ <span class="text-xs text-gray-400" x-text="pco2Range"></span></label>
                                        <div class="flex mt-1">
                                            <input type="number" step="0.1" id="pco2" x-model="values.pco2" 
                                                   @input="validateInput($event)"
                                                   data-min-kpa="1" data-max-kpa="20" 
                                                   class="w-full p-2.5 border rounded-l-md text-base" 
                                                   :placeholder="pco2Units === 'kPa' ? '5.3' : '40'" inputmode="decimal">
                                            <select x-model="pco2Units" @change="convertPco2Units" 
                                                    class="border-t border-b border-r p-2 rounded-r-md bg-gray-50 text-sm">
                                                <option>kPa</option>
                                                <option>mmHg</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Other Values -->
                            <div>
                                <label class="text-sm font-medium text-gray-text">pO‚ÇÇ <span class="text-xs text-gray-400" x-text="po2Range"></span></label>
                                <div class="flex mt-1">
                                    <input type="number" step="0.1" id="po2" x-model="values.po2" 
                                           @input="validateInput($event)"
                                           data-min-kpa="2" data-max-kpa="80" 
                                           class="w-full p-2.5 border rounded-l-md text-base" 
                                           :placeholder="po2Units === 'kPa' ? '12.0' : '90'" inputmode="decimal">
                                    <select x-model="po2Units" @change="convertPo2Units" 
                                            class="border-t border-b border-r p-2 rounded-r-md bg-gray-50 text-sm">
                                        <option>kPa</option>
                                        <option>mmHg</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-text">HCO‚ÇÉ‚Åª <span class="text-xs text-gray-400">(22-26)</span></label>
                                <input type="number" step="0.1" id="hco3" x-model="values.hco3" 
                                       @input="validateInput($event)"
                                       data-min="5" data-max="50" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="24" inputmode="decimal">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-text">Na‚Å∫ <span class="text-xs text-gray-400">(135-145)</span></label>
                                <input type="number" id="sodium" x-model="values.sodium" 
                                       @input="validateInput($event)"
                                       data-min="100" data-max="180" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="140" inputmode="decimal">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-text">K‚Å∫ <span class="text-xs text-gray-400">(3.5-5.0)</span></label>
                                <input type="number" step="0.1" id="potassium" x-model="values.potassium" 
                                       @input="validateInput($event)"
                                       data-min="2.0" data-max="9.0" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="4.0" inputmode="decimal">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-text">Cl‚Åª <span class="text-xs text-gray-400">(98-106)</span></label>
                                <input type="number" id="chloride" x-model="values.chloride" 
                                       @input="validateInput($event)"
                                       data-min="70" data-max="130" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="102" inputmode="decimal">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-text">Lactate <span class="text-xs text-gray-400">(<2.0)</span></label>
                                <input type="number" step="0.1" id="lactate" x-model="values.lactate" 
                                       @input="validateInput($event)"
                                       data-min="0.1" data-max="30" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="1.0" inputmode="decimal">
                            </div>
                            
                            <!-- Collapsible Additional Values -->
                            <div class="sm:col-span-2">
                                <button @click="showAdditional = !showAdditional" 
                                        class="text-sm text-wmebem-blue font-medium flex items-center gap-1">
                                    <span x-text="showAdditional ? '‚ñº' : '‚ñ∂'"></span>
                                    Additional Values
                                </button>
                            </div>
                            <template x-if="showAdditional">
                                <div class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">Albumin <span class="text-xs text-gray-400">(35-50 g/L)</span></label>
                                        <input type="number" id="albumin" x-model="values.albumin" 
                                               data-min="10" data-max="60" 
                                               class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                               placeholder="40" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">Glucose <span class="text-xs text-gray-400">(3.9-5.6)</span></label>
                                        <input type="number" step="0.1" id="glucose" x-model="values.glucose" 
                                               data-min="1.0" data-max="80" 
                                               class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                               placeholder="5.0" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">Ca¬≤‚Å∫ <span class="text-xs text-gray-400">(1.15-1.35)</span></label>
                                        <input type="number" step="0.01" id="calcium" x-model="values.calcium" 
                                               data-min="0.5" data-max="2.0" 
                                               class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                               placeholder="1.25" inputmode="decimal">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-text">Hb <span class="text-xs text-gray-400">(g/L)</span></label>
                                        <input type="number" step="0.1" id="hb" x-model="values.hb" 
                                               data-min="30" data-max="250" 
                                               class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                               placeholder="120" inputmode="decimal">
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Image Upload - Mobile Optimized -->
                        <div x-show="mode === 'image'">
                            <div class="relative">
                                <input type="file" id="image-file-input" @change="handleImageUpload($event)" 
                                       class="hidden" accept="image/*" capture="environment">
                                <label for="image-file-input" 
                                       class="block w-full p-8 border-2 border-dashed border-gray-300 rounded-xl text-center cursor-pointer hover:border-wmebem-blue hover:bg-blue-50 transition-all">
                                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                    </svg>
                                    <span class="block text-base font-medium text-wmebem-blue">Tap to take photo</span>
                                    <span class="block text-xs text-gray-500 mt-1" x-text="fileName || 'or choose from gallery'"></span>
                                </label>
                                <div x-show="imagePreview" class="mt-3">
                                    <img :src="imagePreview" class="max-h-48 mx-auto rounded-lg shadow-md">
                                </div>
                            </div>
                        </div>

                        <!-- Context Fields -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 border-t pt-4 mt-4">
                            <div>
                                <label class="text-sm font-medium text-gray-text">FiO‚ÇÇ (%)</label>
                                <input type="number" step="1" id="fio2" x-model="values.fio2" 
                                       data-min="21" data-max="100" 
                                       class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                       placeholder="21" inputmode="numeric">
                            </div>
                            <div class="sm:col-span-2">
                                <label class="text-sm font-medium text-gray-text">Clinical Context</label>
                                <textarea id="clinicalHistory" x-model="clinicalHistory" 
                                          rows="2" 
                                          class="mt-1 w-full p-2.5 border rounded-md text-base" 
                                          placeholder="e.g., COPD, suspected DKA..."></textarea>
                            </div>
                        </div>

                        <!-- Action Buttons - Mobile Optimized -->
                        <div class="pt-4 flex gap-2">
                            <button @click="clearAll()" 
                                    class="flex-1 py-3 px-4 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                                Clear
                            </button>
                            <button @click="handleAction()" 
                                    :disabled="loading"
                                    class="flex-[2] flex items-center justify-center py-3 px-4 bg-wmebem-navy text-white font-semibold rounded-xl shadow-md hover:bg-wmebem-navy/90 transition-all disabled:opacity-50">
                                <span x-text="loading ? loadingText : (mode === 'image' ? 'üì∑ Read Image' : 'üî¨ Analyze')"></span>
                                <div x-show="loading" class="loader w-5 h-5 ml-3 border-2 rounded-full"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-3" x-show="activeTab === 'results' || windowWidth >= 1024">
                <div x-show="hasResults" class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-gray-200/80">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg md:text-xl font-bold text-wmebem-navy">Analysis Results</h2>
                        <button @click="copyResults()" 
                                class="flex items-center gap-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-text py-2 px-3 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span x-text="copyText">Copy</span>
                        </button>
                    </div>
                    
                    <!-- Results Container -->
                    <div id="resultsContainer" class="space-y-4"></div>
                </div>
                
                <!-- Placeholder -->
                <div x-show="!hasResults" class="bg-white/80 p-8 md:p-12 rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-center min-h-[400px]">
                    <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="text-lg font-semibold text-wmebem-navy">No Results Yet</h3>
                    <p class="text-gray-text mt-1 text-sm">Enter values and click Analyze to see results</p>
                    <button @click="activeTab = 'input'" class="lg:hidden mt-4 text-wmebem-blue font-medium">
                        ‚Üê Go to Input
                    </button>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-xs">
            <p>&copy; <span x-text="new Date().getFullYear()"></span> West Midlands Evidence Based Emergency Medicine Ltd.</p>
            <p class="mt-1">Developed by Dr Jake Turner | Commercial use prohibited</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        function abgApp() {
            return {
                // State
                mode: 'manual',
                activeTab: 'input',
                sampleType: 'Arterial',
                loading: false,
                loadingText: '',
                hasResults: false,
                copyText: 'Copy',
                fileName: '',
                imagePreview: null,
                imageBase64: null,
                showAdditional: false,
                windowWidth: window.innerWidth,
                clinicalHistory: '',
                
                // Units
                pco2Units: 'kPa',
                po2Units: 'kPa',
                
                // Values
                values: {
                    ph: null,
                    pco2: null,
                    po2: null,
                    hco3: null,
                    sodium: null,
                    potassium: null,
                    chloride: null,
                    albumin: null,
                    lactate: null,
                    glucose: null,
                    calcium: null,
                    hb: null,
                    fio2: null
                },
                
                // Computed properties
                get pco2Range() {
                    return this.pco2Units === 'kPa' ? '(4.7-6.0 kPa)' : '(35-45 mmHg)';
                },
                
                get po2Range() {
                    return this.po2Units === 'kPa' ? '(11-13 kPa)' : '(83-98 mmHg)';
                },
                
                // Initialize
                init() {
                    window.addEventListener('resize', () => {
                        this.windowWidth = window.innerWidth;
                    });
                },
                
                // Methods
                handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.fileName = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // More aggressive compression for mobile
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Higher compression for faster uploads
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            this.imageBase64 = dataUrl.split(',')[1];
                            this.imagePreview = dataUrl;
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                
                async handleAction() {
                    if (!navigator.onLine) {
                        this.showError("You appear to be offline. Please check your internet connection.");
                        return;
                    }

                    if (this.mode === 'image') {
                        await this.handleOcr();
                    } else {
                        await this.handleAnalysis();
                    }
                },
                
                async handleOcr() {
                    if (!this.imageBase64) {
                        this.showError("Please select or take a photo first");
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingText = "Reading image...";
                    
                    try {
                        const response = await fetch('/.netlify/functions/ocr', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: this.imageBase64 })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'OCR failed');
                        }
                        
                        // Populate form with OCR results
                        if (Object.values(result).some(v => v !== null)) {
                            Object.keys(result).forEach(key => {
                                if (result[key] !== null && this.values.hasOwnProperty(key)) {
                                    this.values[key] = result[key];
                                }
                            });
                            this.mode = 'manual';
                            this.showInfo("‚úÖ Values extracted! Please verify and click Analyze.");
                            
                            // Switch to input tab on mobile
                            if (this.windowWidth < 1024) {
                                this.activeTab = 'input';
                            }
                        } else {
                            this.showError("Could not read values. Try a clearer photo.");
                        }
                    } catch (error) {
                        this.showError(`OCR failed: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                
                async handleAnalysis() {
                    // Convert units if needed
                    const pco2Value = this.pco2Units === 'mmHg' && this.values.pco2 ? 
                        (this.values.pco2 / 7.5).toFixed(2) : this.values.pco2;
                    const po2Value = this.po2Units === 'mmHg' && this.values.po2 ? 
                        (this.values.po2 / 7.5).toFixed(2) : this.values.po2;
                    
                    if (!this.values.ph || !pco2Value) {
                        this.showError("Please enter at least pH and pCO‚ÇÇ");
                        return;
                    }
                    
                    this.loading = true;
                    this.loadingText = "Analyzing...";
                    
                    try {
                        const analysisValues = {
                            ...this.values,
                            pco2: parseFloat(pco2Value),
                            po2: parseFloat(po2Value)
                        };
                        
                        const response = await fetch('/.netlify/functions/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                values: analysisValues,
                                clinicalHistory: this.clinicalHistory,
                                sampleType: this.sampleType
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Analysis failed');
                        }
                        
                        this.displayResults(result);
                        this.hasResults = true;
                        
                        // Switch to results tab on mobile
                        if (this.windowWidth < 1024) {
                            this.activeTab = 'results';
                        }
                    } catch (error) {
                        this.showError(`Analysis failed: ${error.message}`);
                    } finally {
                        this.loading = false;
                    }
                },
                
                displayResults(interpretation) {
                    const container = document.getElementById('resultsContainer');
                    let html = '';
                    
                    // Check for critical values
                    const ph = parseFloat(this.values.ph);
                    const isCritical = ph && (ph < 7.2 || ph > 7.6);
                    
                    if (interpretation.keyFindings) {
                        html += `
                            <div class="${isCritical ? 'critical-value' : 'bg-blue-50 border border-blue-200'} p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2 flex items-center gap-2">
                                    ${isCritical ? '‚ö†Ô∏è' : 'üìä'} Key Findings
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.keyFindings)}</div>
                            </div>
                        `;
                    }
                    
                    if (interpretation.compensationAnalysis) {
                        html += `
                            <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2">
                                    üéØ Compensation Analysis
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.compensationAnalysis)}</div>
                            </div>
                        `;
                    }
                    
                    if (interpretation.hhAnalysis) {
                        html += `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2">
                                    Henderson-Hasselbalch Analysis
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.hhAnalysis)}</div>
                            </div>
                        `;
                    }
                    
                    if (interpretation.stewartAnalysis) {
                        html += `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2">
                                    Stewart Analysis
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.stewartAnalysis)}</div>
                            </div>
                        `;
                    }
                    
                    if (interpretation.additionalCalculations) {
                        html += `
                            <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2">
                                    Additional Calculations
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.additionalCalculations)}</div>
                            </div>
                        `;
                    }
                    
                    if (interpretation.differentials) {
                        html += `
                            <div class="bg-amber-50 border border-amber-200 p-4 rounded-xl">
                                <h3 class="text-base font-bold text-wmebem-navy mb-2">
                                    üîç Differential Diagnoses
                                </h3>
                                <div class="prose prose-sm max-w-none">${marked.parse(interpretation.differentials)}</div>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = html;
                },
                
                validateInput(event) {
                    const input = event.target;
                    const value = parseFloat(input.value);
                    let min = parseFloat(input.dataset.min);
                    let max = parseFloat(input.dataset.max);
                    
                    if (input.id === 'pco2' || input.id === 'po2') {
                        const units = input.id === 'pco2' ? this.pco2Units : this.po2Units;
                        if (units === 'mmHg') {
                            min = parseFloat(input.dataset.minKpa) * 7.5;
                            max = parseFloat(input.dataset.maxKpa) * 7.5;
                        } else {
                            min = parseFloat(input.dataset.minKpa);
                            max = parseFloat(input.dataset.maxKpa);
                        }
                    }
                    
                    if (input.value && (value < min || value > max)) {
                        input.classList.add('input-error');
                    } else {
                        input.classList.remove('input-error');
                    }
                },
                
                convertPco2Units() {
                    if (this.values.pco2) {
                        if (this.pco2Units === 'mmHg') {
                            // Converting from kPa to mmHg
                            this.values.pco2 = Math.round(this.values.pco2 * 7.5);
                        } else {
                            // Converting from mmHg to kPa
                            this.values.pco2 = (this.values.pco2 / 7.5).toFixed(1);
                        }
                    }
                },
                
                convertPo2Units() {
                    if (this.values.po2) {
                        if (this.po2Units === 'mmHg') {
                            // Converting from kPa to mmHg
                            this.values.po2 = Math.round(this.values.po2 * 7.5);
                        } else {
                            // Converting from mmHg to kPa
                            this.values.po2 = (this.values.po2 / 7.5).toFixed(1);
                        }
                    }
                },
                
                clearAll() {
                    // Reset all values
                    Object.keys(this.values).forEach(key => {
                        this.values[key] = null;
                    });
                    this.clinicalHistory = '';
                    this.fileName = '';
                    this.imagePreview = null;
                    this.imageBase64 = null;
                    this.hasResults = false;
                    document.getElementById('resultsContainer').innerHTML = '';
                    
                    // Clear validation errors
                    document.querySelectorAll('.input-error').forEach(el => {
                        el.classList.remove('input-error');
                    });
                },
                
                copyResults() {
                    const container = document.getElementById('resultsContainer');
                    const text = container.innerText;
                    
                    navigator.clipboard.writeText(text).then(() => {
                        this.copyText = 'Copied!';
                        setTimeout(() => {
                            this.copyText = 'Copy';
                        }, 2000);
                    }).catch(() => {
                        // Fallback
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        this.copyText = 'Copied!';
                        setTimeout(() => {
                            this.copyText = 'Copy';
                        }, 2000);
                    });
                },
                
                showError(message) {
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
                            <p class="font-bold">Error</p>
                            <p>${message}</p>
                        </div>
                    `;
                    this.hasResults = true;
                    if (this.windowWidth < 1024) {
                        this.activeTab = 'results';
                    }
                },
                
                showInfo(message) {
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = `
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md">
                            <p class="font-bold">Success</p>
                            <p>${message}</p>
                        </div>
                    `;
                    this.hasResults = true;
                }
            }
        }
    </script>
</body>
</html>
