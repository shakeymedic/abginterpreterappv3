<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMEBEM ABG/VBG Interpreter Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'wmebem-navy': '#0A2240',
                        'wmebem-blue': '#1A75C4',
                        'bg-light': '#F8F9FA',
                        'gray-text': '#6C757D',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .loader {
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        [x-cloak] { display: none !important; }
        .prose strong { color: #D92D20; }
        .input-error {
            border-color: #D92D20 !important;
            box-shadow: 0 0 0 1px #D92D20;
        }
    </style>
</head>
<body class="bg-bg-light font-sans">

    <div class="container mx-auto p-4 md:p-8" x-data="{ mode: 'manual' }">
        <!-- Header -->
        <header class="text-left mb-10 max-w-6xl mx-auto">
            <div class="flex items-center gap-4">
                <img src="https://i.imgur.com/09eFLTO.png" alt="WMEBEM Logo" class="w-12 h-12">
                <div>
                    <h1 class="text-3xl font-bold text-wmebem-navy">ABG/VBG Interpreter Pro</h1>
                    <p class="text-md text-gray-text">Licensed to West Midlands Evidence Based Emergency Medicine Ltd.</p>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 max-w-6xl mx-auto">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/80 sticky top-8">
                    
                    <h2 class="text-xl font-bold text-wmebem-navy mb-4 border-b pb-4">Patient Data</h2>
                     
                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-text">Sample Type</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center cursor-pointer p-2 rounded-md hover:bg-gray-50 flex-1 justify-center border">
                                <input type="radio" name="sampleType" value="Arterial" class="h-4 w-4 text-wmebem-blue focus:ring-wmebem-blue" checked>
                                <span class="ml-2 text-sm font-medium">Arterial</span>
                            </label>
                            <label class="flex items-center cursor-pointer p-2 rounded-md hover:bg-gray-50 flex-1 justify-center border">
                                <input type="radio" name="sampleType" value="Venous" class="h-4 w-4 text-wmebem-blue focus:ring-wmebem-blue">
                                <span class="ml-2 text-sm font-medium">Venous</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-6 bg-gray-100 p-1 rounded-lg flex space-x-1">
                        <button id="manualModeBtn" @click="mode = 'manual'" :class="{'bg-wmebem-blue text-white': mode === 'manual', 'text-gray-text bg-transparent': mode !== 'manual'}" class="w-full py-2 text-sm font-semibold rounded-md transition-colors">Manual Entry</button>
                        <button id="imageModeBtn" @click="mode = 'image'" :class="{'bg-wmebem-blue text-white': mode === 'image', 'text-gray-text bg-transparent': mode !== 'image'}" class="w-full py-2 text-sm font-semibold rounded-md transition-colors">Upload Image</button>
                    </div>

                    <div class="space-y-4" id="inputForm">
                        <div x-show="mode === 'manual'" x-cloak class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="text-sm font-medium text-gray-text">pH <span class="text-xs text-gray-400 font-normal">(7.35-7.45)</span></label><input type="number" step="0.01" id="ph" data-min="6.8" data-max="7.8" class="mt-1 w-full p-2 border rounded-md" placeholder="7.35"></div>
                            <div><label class="text-sm font-medium text-gray-text">pCO₂ <span class="text-xs text-gray-400 font-normal" id="pco2-range">(4.7-6.0 kPa)</span></label><div class="flex mt-1"><input type="number" step="0.1" id="pco2" data-min-kpa="1" data-max-kpa="20" class="w-full p-2 border rounded-l-md" placeholder="5.5"><select id="pco2_units" class="border-t border-b border-r p-2 rounded-r-md -ml-px bg-gray-50"><option selected>kPa</option><option>mmHg</option></select></div></div>
                            <div><label class="text-sm font-medium text-gray-text">pO₂ <span class="text-xs text-gray-400 font-normal" id="po2-range">(11.1-13.3 kPa)</span></label><div class="flex mt-1"><input type="number" step="0.1" id="po2" data-min-kpa="2" data-max-kpa="80" class="w-full p-2 border rounded-l-md" placeholder="11.0"><select id="po2_units" class="border-t border-b border-r p-2 rounded-r-md -ml-px bg-gray-50"><option selected>kPa</option><option>mmHg</option></select></div></div>
                            <div><label class="text-sm font-medium text-gray-text">HCO₃⁻ <span class="text-xs text-gray-400 font-normal">(22-26 mmol/L)</span></label><input type="number" step="0.1" id="hco3" data-min="5" data-max="50" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Na⁺ <span class="text-xs text-gray-400 font-normal">(135-145 mmol/L)</span></label><input type="number" id="sodium" data-min="100" data-max="180" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">K⁺ <span class="text-xs text-gray-400 font-normal">(3.5-5.0 mmol/L)</span></label><input type="number" step="0.1" id="potassium" data-min="2.0" data-max="9.0" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Cl⁻ <span class="text-xs text-gray-400 font-normal">(98-106 mmol/L)</span></label><input type="number" id="chloride" data-min="70" data-max="130" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Albumin <span class="text-xs text-gray-400 font-normal">(35-50 g/L)</span></label><input type="number" id="albumin" data-min="10" data-max="60" class="mt-1 w-full p-2 border rounded-md" placeholder="g/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Lactate <span class="text-xs text-gray-400 font-normal">(<2.0 mmol/L)</span></label><input type="number" step="0.1" id="lactate" data-min="0.1" data-max="30" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Glucose <span class="text-xs text-gray-400 font-normal">(3.9-5.6 mmol/L)</span></label><input type="number" step="0.1" id="glucose" data-min="1.0" data-max="80" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Ionised Ca²⁺ <span class="text-xs text-gray-400 font-normal">(1.15-1.35 mmol/L)</span></label><input type="number" step="0.01" id="calcium" data-min="0.5" data-max="2.0" class="mt-1 w-full p-2 border rounded-md" placeholder="mmol/L"></div>
                            <div><label class="text-sm font-medium text-gray-text">Hb</label><input type="number" step="0.1" id="hb" data-min="30" data-max="250" class="mt-1 w-full p-2 border rounded-md" placeholder="g/L"></div>
                        </div>

                        <div x-show="mode === 'image'" x-cloak>
                             <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg"><div class="space-y-1 text-center"><svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg><div class="flex text-sm text-gray-600"><label for="image-file-input" class="relative cursor-pointer bg-white rounded-md font-medium text-wmebem-blue hover:text-wmebem-blue"><span>Upload a file or take a photo</span><input id="image-file-input" type="file" class="sr-only" accept="image/*" capture="environment"></label></div><p class="text-xs text-gray-500" id="fileName">PNG, JPG, GIF</p></div></div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t pt-4 mt-4">
                             <div><label for="fio2" class="text-sm font-medium text-gray-text">FiO₂ (%)</label><input type="number" step="1" id="fio2" data-min="21" data-max="100" class="mt-1 w-full p-2 border rounded-md" placeholder="e.g., 21"></div>
                             <div class="sm:col-span-2"><label for="clinicalHistory" class="text-sm font-medium text-gray-text">Clinical History</label><textarea id="clinicalHistory" rows="3" class="mt-1 w-full p-2 border rounded-md" placeholder="e.g., 78 y/o female with COPD..."></textarea></div>
                        </div>

                        <div class="pt-4 flex space-x-2">
                            <button id="clearBtn" class="w-1/3 flex items-center justify-center py-3 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Clear</button>
                            <button id="analyzeBtn" @click="handleAction(mode)" class="w-2/3 flex items-center justify-center py-3 px-4 bg-wmebem-navy text-white font-semibold rounded-lg shadow-md hover:bg-wmebem-navy/90 transition-colors"><span id="analyzeBtnText" x-text="mode === 'manual' ? 'Analyze' : 'Read Image'">Analyze</span><div id="loader" class="hidden loader w-5 h-5 ml-3 border-2 rounded-full"></div></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                 <div id="resultsCard" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200/80 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-wmebem-navy">Interpretation</h2>
                        <button id="copyBtn" class="flex items-center gap-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-text py-2 px-3 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            <span id="copyBtnText">Copy for Records</span>
                        </button>
                    </div>
                    <div id="resultsContainer" class="space-y-4">
                    </div>
                </div>
                <div id="placeholderCard" class="bg-white/80 p-6 rounded-2xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-center h-full">
                    <svg class="w-16 h-16 text-gray-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-1.125 0-2.25.9-2.25 2.25v11.25c0 1.244 1.006 2.25 2.25 2.25h14.25c1.244 0 2.25-1.006 2.25-2.25V10.5M8.25 8.25v-3.108c0-.62-.44-1.158-1.036-1.286a48.421 48.421 0 00-4.124-.372A2.25 2.25 0 00.75 5.25v11.25c0 .621.44 1.158 1.036 1.286a48.421 48.421 0 004.124.372" /></svg>
                    <h3 class="text-lg font-semibold text-wmebem-navy">Awaiting Data</h3>
                    <p class="text-gray-text mt-1">Enter patient data or upload a file to begin analysis.</p>
                </div>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-xs">
            <p>&copy; 2025 West Midlands Evidence Based Emergency Medicine Ltd. All rights reserved.</p>
            <p class="mt-1">Developed by Dr Jake Turner.</p>
            <p class="mt-1">This is a commercial application. Unauthorised use, reproduction, or distribution is strictly prohibited.</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        document.addEventListener('alpine:init', () => {
            
            const imageFileInput = document.getElementById('image-file-input');
            const fileNameDisplay = document.getElementById('fileName');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const analyzeBtnText = document.getElementById('analyzeBtnText');
            const loader = document.getElementById('loader');
            const resultsCard = document.getElementById('resultsCard');
            const placeholderCard = document.getElementById('placeholderCard');
            const resultsContainer = document.getElementById('resultsContainer');
            const copyBtn = document.getElementById('copyBtn');
            const copyBtnText = document.getElementById('copyBtnText');
            const manualModeBtn = document.getElementById('manualModeBtn');
            const clearBtn = document.getElementById('clearBtn');
            const allInputs = document.querySelectorAll('#inputForm input, #inputForm textarea');
            const pco2Units = document.getElementById('pco2_units');
            const po2Units = document.getElementById('po2_units');
            
            let imageBase64 = null;
            let pollingInterval;

            // --- Event Listeners ---
            imageFileInput.addEventListener('change', handleImageUpload);

            window.handleAction = async (currentMode) => {
                if (currentMode === 'image') {
                    await handleOcr();
                } else {
                    await handleAnalysis();
                }
            }

            clearBtn.addEventListener('click', () => {
                allInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('input-error');
                });
                clearResults();
                fileNameDisplay.textContent = 'PNG, JPG, GIF';
                imageBase64 = null;
            });

            pco2Units.addEventListener('change', updateUnitDisplay);
            po2Units.addEventListener('change', updateUnitDisplay);

            allInputs.forEach(input => {
                if(input.type === 'number') {
                    input.addEventListener('input', validateInput);
                }
            });
            
            // --- Core Functions ---
            function handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                fileNameDisplay.textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const MAX_WIDTH = 1024;
                        const MAX_HEIGHT = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        imageBase64 = dataUrl.split(',')[1];
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            async function handleOcr() {
                if (!imageBase64) {
                    showError("Please upload an image to read.");
                    return;
                }
                setLoadingState(true, "Reading Image...");
                clearResults();

                try {
                    const response = await fetch('/api/ocr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageBase64 })
                    });

                    if (!response.ok) { throw new Error(await response.text()); }
                    const extractedValues = await response.json();
                    
                    if(Object.values(extractedValues).every(v => v === null)){
                        throw new Error("OCR could not read any values from the image. Please ensure the image is clear and well-lit.");
                    }

                    populateForm(extractedValues);
                    manualModeBtn.click();
                    showInfo("OCR complete. Please verify the extracted values below, then click 'Analyze'.");
                } catch (error) {
                    let errorMessage = error.message;
                    try { const parsedError = JSON.parse(errorMessage); errorMessage = parsedError.error || errorMessage; } catch(e) { /* use raw message */ }
                    showError(`Failed to read image. ${errorMessage}`);
                } finally {
                    setLoadingState(false);
                }
            }
            
            async function handleAnalysis() {
                setLoadingState(true, "Analyzing...");
                clearResults();
                showInfo("Analysis submitted. This may take up to a minute for complex cases. Please wait...");

                const manualValues = getManualValues();
                if (!manualValues.ph || !manualValues.pco2) {
                    showError("Please enter at least pH and pCO₂ to perform analysis.");
                    setLoadingState(false);
                    return;
                }

                try {
                    const startResponse = await fetch('/api/start-analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            values: manualValues,
                            clinicalHistory: document.getElementById('clinicalHistory').value,
                            sampleType: document.querySelector('input[name="sampleType"]:checked').value
                        })
                    });

                    if (!startResponse.ok) { throw new Error(await startResponse.text()); }
                    const { jobId } = await startResponse.json();

                    // Start polling for the result
                    pollForResult(jobId);

                } catch (error) {
                    let errorMessage = error.message;
                    try { const parsedError = JSON.parse(errorMessage); errorMessage = parsedError.error || errorMessage; } catch (e) {}
                    showError(`Failed to start analysis: ${errorMessage}`);
                    setLoadingState(false);
                }
            }

            function pollForResult(jobId) {
                let attempts = 0;
                pollingInterval = setInterval(async () => {
                    if (attempts >= 20) { // 60 second timeout
                        clearInterval(pollingInterval);
                        showError("Analysis timed out. The server is taking too long to respond. Please try again later.");
                        setLoadingState(false);
                        return;
                    }
                    try {
                        const statusResponse = await fetch(`/api/check-status?id=${jobId}`);
                        if (!statusResponse.ok) {
                            // Don't throw, just log it and continue polling
                            console.error(`Polling failed with status: ${statusResponse.status}`);
                            return;
                        }
                        
                        const result = await statusResponse.json();
                        
                        if (result.status === 'complete') {
                            clearInterval(pollingInterval);
                            setLoadingState(false);
                            displayInterpretation(result.data);
                        } else if (result.status === 'failed') {
                            clearInterval(pollingInterval);
                            setLoadingState(false);
                            showError(`Analysis failed: ${result.error}`);
                        }
                        // If status is 'pending', do nothing and wait for the next interval
                    } catch (error) {
                        // Don't throw, just log it and continue polling
                        console.error("Error during polling:", error);
                    } finally {
                        attempts++;
                    }
                }, 3000); // Poll every 3 seconds
            }


            // --- Helper Functions ---
            function populateForm(values) {
                const fields = ['ph', 'pco2', 'po2', 'hco3', 'sodium', 'potassium', 'chloride', 'albumin', 'lactate', 'glucose', 'calcium', 'hb'];
                fields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element && values[field] !== null && values[field] !== undefined) {
                        element.value = values[field];
                    }
                });
            }

            function displayInterpretation(interpretation) {
                let html = '';
                if (interpretation.keyFindings) { html += `<div class="bg-blue-50 border border-wmebem-blue/30 p-4 rounded-xl"><h3 class="text-base font-semibold text-wmebem-navy mb-2">Key Findings</h3><div class="prose prose-lg max-w-none">${marked.parse(interpretation.keyFindings)}</div></div>`; }
                if (interpretation.hhAnalysis) { html += `<div class="bg-gray-50 border p-4 rounded-xl"><h3 class="text-base font-semibold text-wmebem-navy mb-2">Henderson-Hasselbalch Analysis</h3><div class="prose prose-lg max-w-none">${marked.parse(interpretation.hhAnalysis)}</div></div>`; }
                if (interpretation.stewartAnalysis) { html += `<div class="bg-gray-50 border p-4 rounded-xl"><h3 class="text-base font-semibold text-wmebem-navy mb-2">Stewart (Physicochemical) Analysis</h3><div class="prose prose-lg max-w-none">${marked.parse(interpretation.stewartAnalysis)}</div></div>`; }
                if (interpretation.additionalCalculations) { html += `<div class="bg-gray-50 border p-4 rounded-xl"><h3 class="text-base font-semibold text-wmebem-navy mb-2">Additional Calculations</h3><div class="prose prose-lg max-w-none">${marked.parse(interpretation.additionalCalculations)}</div></div>`; }
                if (interpretation.differentials) { html += `<div class="bg-gray-50 border p-4 rounded-xl"><h3 class="text-base font-semibold text-wmebem-navy mb-2">Potential Differential Diagnoses</h3><div class="prose prose-lg max-w-none">${marked.parse(interpretation.differentials)}</div></div>`; }
                resultsContainer.innerHTML = html;
                
                resultsCard.classList.remove('hidden');
                placeholderCard.classList.add('hidden');
            }

            function getManualValues() {
                const pco2_val = parseFloat(document.getElementById('pco2').value);
                const pco2_units = document.getElementById('pco2_units').value;
                const po2_val = parseFloat(document.getElementById('po2').value);
                const po2_units = document.getElementById('po2_units').value;
                return {
                    ph: parseFloat(document.getElementById('ph').value) || null,
                    pco2: isNaN(pco2_val) ? null : (pco2_units === 'mmHg' ? (pco2_val / 7.5) : pco2_val),
                    po2: isNaN(po2_val) ? null : (po2_units === 'mmHg' ? (po2_val / 7.5) : po2_val),
                    fio2: parseFloat(document.getElementById('fio2').value) || null,
                    hco3: parseFloat(document.getElementById('hco3').value) || null,
                    sodium: parseFloat(document.getElementById('sodium').value) || null,
                    potassium: parseFloat(document.getElementById('potassium').value) || null,
                    chloride: parseFloat(document.getElementById('chloride').value) || null,
                    albumin: parseFloat(document.getElementById('albumin').value) || null,
                    lactate: parseFloat(document.getElementById('lactate').value) || null,
                    glucose: parseFloat(document.getElementById('glucose').value) || null,
                    calcium: parseFloat(document.getElementById('calcium').value) || null,
                    hb: parseFloat(document.getElementById('hb').value) || null
                };
            }

            function setLoadingState(isLoading, text) {
                analyzeBtn.disabled = isLoading;
                analyzeBtn.classList.toggle('opacity-75', isLoading);
                if(isLoading) {
                    analyzeBtnText.textContent = text;
                }
                loader.classList.toggle('hidden', !isLoading);
            }
            
            function clearResults() {
                clearInterval(pollingInterval);
                resultsContainer.innerHTML = '';
                resultsCard.classList.add('hidden');
                placeholderCard.classList.remove('hidden');
            }

            function showError(message) {
                clearInterval(pollingInterval);
                clearResults();
                resultsContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"><p class="font-bold">Error</p><p>${message}</p></div>`;
                resultsCard.classList.remove('hidden');
                placeholderCard.classList.add('hidden');
            }
            
            function showInfo(message) {
                clearResults();
                resultsContainer.innerHTML = `<div class="bg-blue-100 border-l-4 border-wmebem-blue text-wmebem-navy p-4 rounded-md" role="alert"><p class="font-bold">Action Required</p><p>${message}</p></div>`;
                resultsCard.classList.remove('hidden');
                placeholderCard.classList.add('hidden');
            }
            
            function updateUnitDisplay(event) {
                const selectEl = event.target;
                const inputEl = selectEl.previousElementSibling;
                const rangeEl = selectEl.parentElement.previousElementSibling.querySelector('span');
                const isKpa = selectEl.value === 'kPa';
                const kpaMin = parseFloat(inputEl.dataset.minKpa);
                const kpaMax = parseFloat(inputEl.dataset.maxKpa);

                if (isKpa) {
                    rangeEl.textContent = `(${kpaMin}-${kpaMax} kPa)`;
                } else {
                    const mmhgMin = (kpaMin * 7.5).toFixed(0);
                    const mmhgMax = (kpaMax * 7.5).toFixed(0);
                    rangeEl.textContent = `(${mmhgMin}-${mmhgMax} mmHg)`;
                }
            }

            function validateInput(event){
                const input = event.target;
                const value = parseFloat(input.value);
                let min = parseFloat(input.dataset.min);
                let max = parseFloat(input.dataset.max);

                if (input.id === 'pco2' || input.id === 'po2') {
                    const units = document.getElementById(`${input.id}_units`).value;
                    if (units === 'mmHg') {
                        min = parseFloat(input.dataset.minKpa) * 7.5;
                        max = parseFloat(input.dataset.maxKpa) * 7.5;
                    } else {
                         min = parseFloat(input.dataset.minKpa);
                         max = parseFloat(input.dataset.maxKpa);
                    }
                }
                
                if (input.value && (value < min || value > max)) {
                    input.classList.add('input-error');
                } else {
                    input.classList.remove('input-error');
                }
            }

            copyBtn.addEventListener('click', () => {
                const textToCopy = resultsContainer.innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyBtnText.textContent = 'Copied!';
                    setTimeout(() => { copyBtnText.textContent = 'Copy for Records'; }, 2000);
                });
            });
        });
    </script>
</body>
</html>

